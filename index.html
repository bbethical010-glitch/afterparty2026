<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Encore Organizer Hub</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Montserrat', sans-serif;
  background: #050510;
}
h1,h2 { font-family: 'Orbitron', sans-serif; }
.glass {
  background: rgba(20,20,40,0.8);
  backdrop-filter: blur(12px);
  border: 1px solid rgba(255,255,255,0.15);
}
</style>
</head>

<body>

<!-- PASSWORD GATE -->
<div id="login" class="min-h-screen flex items-center justify-center">
  <div class="glass p-6 rounded-xl w-80 text-center">
    <h2 class="text-white mb-4">Organizer Login</h2>
    <input id="pw" type="password" placeholder="Password"
      class="w-full p-3 mb-4 rounded bg-black text-white">
    <button onclick="unlock()" class="w-full bg-pink-500 text-black font-bold py-2 rounded">
      Enter Hub
    </button>
  </div>
</div>

<!-- MAIN HUB -->
<div id="hub" class="hidden min-h-screen p-6 flex flex-col items-center">

<h1 class="text-white text-3xl mb-6">Encore Organizer Hub</h1>

<!-- SEARCH -->
<div class="glass p-6 rounded-xl w-full max-w-md mb-6">
  <input id="entryId" placeholder="Enter ID (JAI-0XX)"
    class="w-full p-3 text-center text-lg uppercase rounded bg-black text-white mb-4">
  <button id="fetchBtn"
    class="w-full bg-cyan-400 text-black font-bold py-2 rounded">
    Fetch Guest
  </button>
</div>

<!-- RESULT -->
<div id="card" class="glass p-6 rounded-xl w-full max-w-md hidden text-white">
  <p><strong>Name:</strong> <span id="name"></span></p>
  <p><strong>ID:</strong> <span id="gid"></span></p>
  <p><strong>Payment:</strong> <span id="paid"></span></p>
  <p><strong>Entry:</strong> <span id="used"></span></p>

  <div class="flex gap-3 mt-4">
    <button id="togglePay"
      class="flex-1 bg-yellow-400 text-black font-bold py-2 rounded">
      Toggle Payment
    </button>
    <button id="verify"
      class="flex-1 bg-green-400 text-black font-bold py-2 rounded">
      Verify Entry
    </button>
  </div>

  <p id="msg" class="mt-4 text-center text-lg"></p>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, updateDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBoMIeT_axIVSyyhBC8PRzcO9z0bhIIyXA",
  authDomain: "encore-entry-system.firebaseapp.com",
  projectId: "encore-entry-system"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentRef = null;
let currentData = null;

// DOM references
const card = document.getElementById("card");
const nameEl = document.getElementById("name");
const gidEl = document.getElementById("gid");
const paidEl = document.getElementById("paid");
const usedEl = document.getElementById("used");
const msgEl = document.getElementById("msg");
const verifyBtn = document.getElementById("verify");

document.getElementById("fetchBtn").onclick = async () => {
  const id = entryId.value.trim().toUpperCase();
  if (!id) return;

  // Reset UI
  card.classList.add("hidden");
  msgEl.innerText = "";
  verifyBtn.disabled = false;

  const ref = doc(db, "guest_list", id);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    alert("ID not found");
    return;
  }

  currentRef = ref;
  currentData = snap.data();

  // Defensive defaults
  const paid = !!currentData.paid;
  const checkedIn = !!currentData.checkedIn;

  card.classList.remove("hidden");
  nameEl.innerText = currentData.name || "â€”";
  gidEl.innerText = id;
  paidEl.innerText = paid ? "PAID" : "NOT PAID";
  paidEl.className = paid ? "text-green-400" : "text-yellow-400";
  usedEl.innerText = checkedIn ? "USED" : "NOT USED";
  usedEl.className = checkedIn ? "text-red-400" : "text-cyan-400";

  if (checkedIn) {
    msgEl.innerText = "Already Used";
    msgEl.className = "text-red-400 text-lg";
    verifyBtn.disabled = true;
  }
};

togglePay.onclick = async () => {
  if (!currentRef) return;

  currentData.paid = !currentData.paid;
  await updateDoc(currentRef, { paid: currentData.paid });

  paidEl.innerText = currentData.paid ? "PAID" : "NOT PAID";
  paidEl.className = currentData.paid ? "text-green-400" : "text-yellow-400";

  msgEl.innerText = "Payment status updated";
  msgEl.className = "text-cyan-400";
};

verify.onclick = async () => {
  if (!currentRef) return;

  if (currentData.checkedIn) {
    msgEl.innerText = "Already Used";
    msgEl.className = "text-red-400";
    return;
  }

  if (!currentData.paid) {
    msgEl.innerText = "Payment Pending";
    msgEl.className = "text-yellow-400";
    return;
  }

  await updateDoc(currentRef, {
    checkedIn: true,
    checkedInAt: serverTimestamp()
  });

  currentData.checkedIn = true;
  usedEl.innerText = "USED";
  usedEl.className = "text-red-400";
  verifyBtn.disabled = true;

  msgEl.innerText = "ENTRY APPROVED";
  msgEl.className = "text-green-400 text-xl";
};
</script>

<script>
const PASSWORD = "ENCORE2026";
function unlock() {
  if (pw.value === PASSWORD) {
    login.classList.add("hidden");
    hub.classList.remove("hidden");
  } else {
    alert("Wrong password");
  }
}
</script>

</body>
</html>
